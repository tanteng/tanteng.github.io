<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.6" />

    
    
    

<title>ThinkPHP的RBAC（基于角色权限控制）详解 • 小谈博客</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ThinkPHP的RBAC（基于角色权限控制）详解"/>
<meta name="twitter:description" content="一、什么是RBAC

基于角色的访问控制（Role-Based Access Control）作为传统访问控制（自主访问，强制访问）的有前景的代替受到广泛的关注。

在RBAC中，权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限。这就极大地简化了权限的管理。

在一个组织中，角色是为了完成各种工作而创造，用户则依据它的责任和资格来被指派相应的角色，用户可以很容易地从一个角色被指派到另一个角色。角色可依新的需求和系统的合并而赋予新的权限，而权限也可根据需要而从某角色中回收。角色与角色的关系可以建立起来以囊括更广泛的客观情况。"/>

<meta property="og:title" content="ThinkPHP的RBAC（基于角色权限控制）详解" />
<meta property="og:description" content="一、什么是RBAC

基于角色的访问控制（Role-Based Access Control）作为传统访问控制（自主访问，强制访问）的有前景的代替受到广泛的关注。

在RBAC中，权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限。这就极大地简化了权限的管理。

在一个组织中，角色是为了完成各种工作而创造，用户则依据它的责任和资格来被指派相应的角色，用户可以很容易地从一个角色被指派到另一个角色。角色可依新的需求和系统的合并而赋予新的权限，而权限也可根据需要而从某角色中回收。角色与角色的关系可以建立起来以囊括更广泛的客观情况。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://tanteng.me/2012/11/thinkphp-rbac/" />
<meta property="article:published_time" content="2012-11-25T07:15:58&#43;00:00"/>
<meta property="article:modified_time" content="2012-11-25T07:15:58&#43;00:00"/>


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.6a83d62c39a364f036df4db1ecd564645635d6c7fc182425cb501218fec485f5.css" integrity="sha256-aoPWLDmjZPA2302x7NVkZFY11sf8GCQly1ASGP7EhfU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="http://tanteng.me/">小谈博客</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="http://tanteng.me/img/avatar.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         一个专注 WEB 技术的博客 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">小谈博客</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	
	<a href="https://facebook.com/tanteng001" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/tanteng" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/tanteng1031" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/tanteng" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 TonyTan
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>ThinkPHP的RBAC（基于角色权限控制）详解</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Nov 25, 2012
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/develop">DEVELOP</a>
              •
          
              <a class="badge badge-category" href="/categories/php">PHP</a>
              •
          
              <a class="badge badge-category" href="/categories/thinkphp">THINKPHP</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 1 min read
</div>


  </header>
  
  
  <div class="post">
    <h1 id="一-什么是rbac">一、什么是RBAC</h1>

<p>基于角色的访问控制（Role-Based Access Control）作为传统访问控制（自主访问，强制访问）的有前景的代替受到广泛的关注。</p>

<p>在RBAC中，权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限。这就极大地简化了权限的管理。</p>

<p>在一个组织中，角色是为了完成各种工作而创造，用户则依据它的责任和资格来被指派相应的角色，用户可以很容易地从一个角色被指派到另一个角色。角色可依新的需求和系统的合并而赋予新的权限，而权限也可根据需要而从某角色中回收。角色与角色的关系可以建立起来以囊括更广泛的客观情况。</p>

<h1 id="二-thinkphp中的rbac">二、ThinkPHP中的RBAC</h1>

<p>先看下官方给的实例所用到的数据表，通过5张表实现权限控制，定义如下：</p>

<p>RBAC 要用到5个数据表</p>

<p>think_user (用户表)</p>

<p>think_role (用户分组表)</p>

<p>think_node (操作节点)</p>

<p>think_role_user (用户和用户分组的对应)</p>

<p>think_access (各个操作和用户组的对应)</p>

<p><img class="alignnone" src="https://twwuha.bay.livefilestore.com/y1pmMpSjAkuQi_ZQObSfD7BeRH8S949DaZxJkHQ8PlgWIE73EQNXlmBCodTZCdoAAhtIyOKERFfb6O86d0FqNSOnGg3XtDiZEL4/user.png?psid=1" alt="" width="1213" height="217" /></p>

<p>用户表</p>

<p><img class="alignnone" src="https://twwuha.bay.livefilestore.com/y1pOGM8TYRf8ITaOSjD0815v8xBCTyQXmzTRGIWn1g2EmsFLFpxkMwx_MNBxUFP6XDVHpBi235GMFBPRX2QJVS-VI-7CiDPTEDU/role.png?psid=1" alt="" width="610" height="89" /></p>

<p>角色表，有哪些角色，该角色与对应的userid用户相关联</p>

<p><img class="alignnone" src="https://twwuha.bay.livefilestore.com/y1pEfyPz7-Uz8fdNbt8veE9nqtkhrK7hXOdjap3QxbjmTflEYquDl0ZtQKwxHQ57UtViKY_Gcot3V6sE1MdWw4sdGit2MJRiSNp/role_user.png?psid=1" alt="" width="240" height="318" /></p>

<p>根据用户表的id给出对应的角色id相关联，也就是给用户分配角色，比如userid为3的角色为2，根据role角色表，7代表员工的角色</p>

<p><img class="alignnone" src="https://twwuha.bay.livefilestore.com/y1pOGM8TYRf8ITyCrFQRxZaRPk0fS-_7GY7MfKKPSiXosjoL01Us9qull3NaiDu2_H8Ny9og-3S1f6RoVIW2F4J4u66HbAo_IyT/access.png?psid=1" alt="" width="398" height="608" /></p>

<p>access表，权限表，比如角色id为2，也就是员工的权限，可以的对应的结点</p>

<p><img class="alignnone" src="https://twwuha.bay.livefilestore.com/y1pOGM8TYRf8ITOGUqVXhxL18ZLLGvygSsI-zyAozR3Waq0zVqzrSYKBG_qkqeCDg7OGkkpKwkOSYUylK6Fe0NUhK_H97zEf_LV/note.png?psid=1" alt="" width="719" height="457" /></p>

<p>结点表，代表有哪些应用-模块-模块方法，并且定义了之间的一种关系，比如noteid为30的是Public模块，noteid为31，32，33，34的方法add，insert，edit，update都属于Public。noteid为85的test方法，属于noteid为84的Game模块下的方法。</p>

<h1 id="三-config配置文件详解">三、config配置文件详解</h1>

<p>我们看看thinkphp官方示例中的config文件:</p>

<p><code lang="php">array(
        &lsquo;APP_AUTOLOAD_PATH&rsquo;=&gt;&lsquo;@.TagLib&rsquo;,
        &lsquo;SESSION_AUTO_START&rsquo;=&gt;true,
        &lsquo;USER_AUTH_ON&rsquo;              =&gt;true,
        &lsquo;USER_AUTH_TYPE&rsquo;            =&gt;1,        // 默认认证类型 1 登录认证 2 实时认证
        &lsquo;USER_AUTH_KEY&rsquo;             =&gt;&lsquo;authId&rsquo;, // 用户认证SESSION标记
        &lsquo;ADMIN_AUTH_KEY&rsquo;            =&gt;&lsquo;administrator&rsquo;,
        &lsquo;USER_AUTH_MODEL&rsquo;           =&gt;&lsquo;User&rsquo;,   // 默认验证数据表模型
        &lsquo;AUTH_PWD_ENCODER&rsquo;          =&gt;&lsquo;md5&rsquo;,    // 用户认证密码加密方式
        &lsquo;USER_AUTH_GATEWAY&rsquo;         =&gt;&lsquo;/Public/login&rsquo;,// 默认认证网关
        &lsquo;NOT_AUTH_MODULE&rsquo;           =&gt;&lsquo;Public&rsquo;, // 默认无需认证模块
        &lsquo;REQUIRE_AUTH_MODULE&rsquo;       =&gt;&ldquo;,       // 默认需要认证模块
        &lsquo;NOT_AUTH_ACTION&rsquo;           =&gt;&ldquo;,       // 默认无需认证操作
        &lsquo;REQUIRE_AUTH_ACTION&rsquo;       =&gt;&ldquo;,       // 默认需要认证操作
        &lsquo;GUEST_AUTH_ON&rsquo;             =&gt;false,    // 是否开启游客授权访问
        &lsquo;GUEST_AUTH_ID&rsquo;             =&gt;0,        // 游客的用户ID
        &lsquo;DB_LIKE_FIELDS&rsquo;            =&gt;&lsquo;title|remark&rsquo;,
        &lsquo;RBAC_ROLE_TABLE&rsquo;           =&gt;&lsquo;think_role&rsquo;,
        &lsquo;RBAC_USER_TABLE&rsquo;           =&gt;&lsquo;think_role_user&rsquo;,
        &lsquo;RBAC_ACCESS_TABLE&rsquo;         =&gt;&lsquo;think_access&rsquo;,
        &lsquo;RBAC_NODE_TABLE&rsquo;           =&gt;&lsquo;think_node&rsquo;,
        &lsquo;SHOW_PAGE_TRACE&rsquo;=&gt;1//显示调试信息
    );
</code></p>

<p>大家看注释就应该懂大半了，其中Public模块是无需认证的，道理很简单，没登录之前大家都是游客身份，如果登录页面也要权限，那从哪里登录呢？是吧，呵呵。默认网关地址就是认证失败，没有权限跳转到此处，重新登陆。ADMIN_AUTH_KEY表示超级管理员权限，如果你在user表建立一个名为admin的用户，那么这个用户就是超级管理员，不用给它分配权限，什么权限都有，为什么要设置一个这样的管理员，因为当你把权限分配错了容易引起系统权限混乱，搞得大家都访问不了，这时候超级管理员就来了。</p>

<h1 id="四-rbac类的几个重要的方法">四、RBAC类的几个重要的方法</h1>

<p>authenticate($map,$model=&#8221;)方法 传入查询用户的条件和用户表的MODEL 返回数组包含用户的信息</p>

<p>saveAccessList($authId=null)方法 传入用户的ID 此方法不返回值，只是设置 $_SESSION[&#8216;_ACCESS_LIST&#8217;]的值，其中包含了所有该用户对应的用户组的有权限操作的所有节点 $_SESSION[&#8216;_ACCESS_LIST&#8217;][&#8216;项目名&#8217;][&#8216;模块名&#8217;][&#8216;操作名&#8217;]，以后判断权限就是判断当前项目，模块和操作是否在 $_SESSION[&#8216;_ACCESS_LIST&#8217;]中能找到。s</p>

<p>checkAccess() 方法 检测当前模块和操作是否需要验证 返回bool类型</p>

<p>checkLogin()方法 检测登录</p>

<p>AccessDecision($appName=APP_NAME) 方法 就是检测当前项目模块操作 是否在$_SESSION[&#8216;_ACCESS_LIST&#8217;]数组中，也就是说 在 $_SESSION[&#8216;_ACCESS_LIST&#8217;] 数组中$_SESSION[&#8216;_ACCESS_LIST&#8217;][&#8216;当前操作&#8217;][&#8216;当前模块&#8217;][&#8216;当前操作&#8217;]是否存在。如果存在表示有权限 否则返回flase。</p>

<p>getAccessList($authId) 方法 通过查询数据库 返回权限列表 $_SESSION[&#8216;_ACCESS_LIST&#8217;]的值了。</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2012/11/thinkphp-sql/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">thinkphp的sql优化原则</span>
    </a>
    
    
    <a href="/2012/12/navica-10/" class="navigation-next">
      <span class="navigation-tittle">Navicat10.x注册码</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script src="https://cdn.bootcss.com/font-awesome/5.5.0/js/all.min.js"></script>

    
    
        <script src="https://cdn.bootcss.com/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
