<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>PHP5.6 curl去除@语法 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">PHP5.6 curl去除@语法</h1>
    <span class="post-date">Aug 4, 2015 &middot; 1 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/php">PHP</a>
    </span>
    <p>在一个传图方法中用到了curl上传文件，在文件名前加上@语法表示上传文件，这在PHP5.3中是正常的，但是在PHP5.6中彻底废除了@语法，导致上传图片无法使用。</p>

<pre class="lang:php mark:5 decode:true ">//支持远程文件上传
if(empty($urlinfo['host'])){
    $tmp_name=dirname($file['tmp_name']).'/'.$file['title'].'.'.$file['extension'];//加上文件后缀
    rename($file['tmp_name'],$tmp_name);
    $fields['file'] = '@'.$tmp_name;//加@符号curl就会把它当成是文件上传处理
}else{
    $fields['url']=$file['tmp_name'];
}</pre>

<p>第5行，在文件名前加上@符合，curl会把它当作文件上传处理，这在PHP5.3中是正常的。cURL上传文件代码如下：</p>

<pre class="lang:php decode:true ">$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,$this-&gt;config['postUrl']);
curl_setopt($ch, CURLOPT_POST,true);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 1); //连接超时
curl_setopt($ch, CURLOPT_POSTFIELDS,$fields);
$data=curl_exec ($ch);
$info=curl_getinfo($ch);
curl_close($ch);</pre>

<p>在PHP5.6中，curl中CURLOPT_POSTFIELDS参数这样写表示上传文件：</p>

<pre class="lang:php decode:true">curl_setopt(ch, CURLOPT_POSTFIELDS, [
    'file' =&gt; new CURLFile(realpath('image.png')), 
]);</pre>

<p>CURLFile方法是在PHP5.5中新加的，在PHP5.6中彻底废除了@语法，因此要么使用PHP5.3的方式，要么使用PHP5.6的方式，两者只能选其一，不能兼容。实在没办法，可以用：</p>

<pre class="lang:php decode:true ">if (version_compare(phpversion(), '5.4.0') &gt;= 0)</pre>

<p>这个函数来判断PHP版本选择不同的方式，但是这种方式不推荐，还是统一环境最好。</p>

<p>如果一定要兼容不同版本的PHP，参考以下写法：</p>

<pre class="lang:php mark:4 decode:true">if(empty($urlinfo['host'])){
    $tmp_name=dirname($file['tmp_name']).'/'.$file['title'].'.'.$file['extension'];//加上文件后缀
    rename($file['tmp_name'],$tmp_name);
    if(version_compare(phpversion(),'5.5.0') &gt;= 0 && class_exists('CURLFile')){
        $fields['file'] = new CURLFile(realpath($tmp_name));
    }else{
        $fields['file'] = '@'.$tmp_name;//加@符号curl就会把它当成是文件上传处理
    }
}else{
    $fields['url']=$file['tmp_name'];
}
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,$this-&gt;config['postUrl']);
curl_setopt($ch, CURLOPT_POST,true);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 1); //连接超时
curl_setopt($ch, CURLOPT_POSTFIELDS,$fields);
$data=curl_exec ($ch);
$info=curl_getinfo($ch);
curl_close($ch);</pre>

<p>（本文参考文章：<a href="http://segmentfault.com/a/1190000000725185" target="_blank" rel="nofollow"><a href="http://segmentfault.com/a/1190000000725185">http://segmentfault.com/a/1190000000725185</a></a>）</p>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

