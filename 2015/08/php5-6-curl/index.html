<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.55.6" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PHP5.6 curl去除@语法 &middot; 小谈博客</title>

  
  <link type="text/css" rel="stylesheet" href="http://tanteng.me/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://tanteng.me/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://tanteng.me/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>PHP5.6 curl去除@语法</h1>
  <time datetime=2015-08-04T10:24:53Z class="post-date">Tue, Aug 4, 2015</time>
  <p>在一个传图方法中用到了curl上传文件，在文件名前加上@语法表示上传文件，这在PHP5.3中是正常的，但是在PHP5.6中彻底废除了@语法，导致上传图片无法使用。</p>

<pre class="lang:php mark:5 decode:true ">//支持远程文件上传
if(empty($urlinfo['host'])){
    $tmp_name=dirname($file['tmp_name']).'/'.$file['title'].'.'.$file['extension'];//加上文件后缀
    rename($file['tmp_name'],$tmp_name);
    $fields['file'] = '@'.$tmp_name;//加@符号curl就会把它当成是文件上传处理
}else{
    $fields['url']=$file['tmp_name'];
}</pre>

<p>第5行，在文件名前加上@符合，curl会把它当作文件上传处理，这在PHP5.3中是正常的。cURL上传文件代码如下：</p>

<pre class="lang:php decode:true ">$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,$this-&gt;config['postUrl']);
curl_setopt($ch, CURLOPT_POST,true);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 1); //连接超时
curl_setopt($ch, CURLOPT_POSTFIELDS,$fields);
$data=curl_exec ($ch);
$info=curl_getinfo($ch);
curl_close($ch);</pre>

<p>在PHP5.6中，curl中CURLOPT_POSTFIELDS参数这样写表示上传文件：</p>

<pre class="lang:php decode:true">curl_setopt(ch, CURLOPT_POSTFIELDS, [
    'file' =&gt; new CURLFile(realpath('image.png')), 
]);</pre>

<p>CURLFile方法是在PHP5.5中新加的，在PHP5.6中彻底废除了@语法，因此要么使用PHP5.3的方式，要么使用PHP5.6的方式，两者只能选其一，不能兼容。实在没办法，可以用：</p>

<pre class="lang:php decode:true ">if (version_compare(phpversion(), '5.4.0') &gt;= 0)</pre>

<p>这个函数来判断PHP版本选择不同的方式，但是这种方式不推荐，还是统一环境最好。</p>

<p>如果一定要兼容不同版本的PHP，参考以下写法：</p>

<pre class="lang:php mark:4 decode:true">if(empty($urlinfo['host'])){
    $tmp_name=dirname($file['tmp_name']).'/'.$file['title'].'.'.$file['extension'];//加上文件后缀
    rename($file['tmp_name'],$tmp_name);
    if(version_compare(phpversion(),'5.5.0') &gt;= 0 && class_exists('CURLFile')){
        $fields['file'] = new CURLFile(realpath($tmp_name));
    }else{
        $fields['file'] = '@'.$tmp_name;//加@符号curl就会把它当成是文件上传处理
    }
}else{
    $fields['url']=$file['tmp_name'];
}
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL,$this-&gt;config['postUrl']);
curl_setopt($ch, CURLOPT_POST,true);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 1); //连接超时
curl_setopt($ch, CURLOPT_POSTFIELDS,$fields);
$data=curl_exec ($ch);
$info=curl_getinfo($ch);
curl_close($ch);</pre>

<p>（本文参考文章：<a href="http://segmentfault.com/a/1190000000725185" target="_blank" rel="nofollow"><a href="http://segmentfault.com/a/1190000000725185">http://segmentfault.com/a/1190000000725185</a></a>）</p>
</div>


    </main>

    
  </body>
</html>
