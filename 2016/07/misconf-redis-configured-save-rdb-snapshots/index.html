<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>解决 Redis 只读不可写的问题 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">解决 Redis 只读不可写的问题</h1>
    <span class="post-date">Jul 15, 2016 &middot; 1 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/redis">Redis</a><a class="label" href="http://tanteng.me/categories/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a><a class="label" href="http://tanteng.me/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a>
    </span>
    <p>在 Redis 终端上进行读写操作，发现只读不可写，GET 操作是正常的，SET 操作提示错误：(error)MISCONF Redis is configured to save RDB snapshots,but is currently not able to persist on disk. Commands that may modify the data set are disabled. 如图所示：</p>

<p><a href="https://blog.tanteng.me/wp-content/uploads/2016/07/misconf-redis-is-configured-to-save-rdb-snapashots.png" target="_blank"><img class="alignnone wp-image-10253 size-full" src="https://blog.tanteng.me/wp-content/uploads/2016/07/misconf-redis-is-configured-to-save-rdb-snapashots.png" alt="misconf-redis-is-configured-to-save-rdb-snapashots" width="732" height="120" /></a></p>

<p>这一问题通报给运维后得到解决，方法是修改配置为 <span class="attribute">vm.overcommit_memory</span>=<span class="attribute-value">1.</span></p>

<p>原因：</p>

<blockquote>
<p>Redis 在保存数据到硬盘时为了避免主进程假死，需要 Fork 一份主进程，然后在 Fork 进程内完成数据保存到硬盘的操作，如果主进程使用了 4 GB 的内存，Fork 子进程的时候需要额外的 4 GB，此时内存就不够了，Fork 失败，进而数据保存硬盘也失败了。</p>
</blockquote>

<p>Linux 内核会根据参数 vm.overcommit_memory 参数的设置决定是否放行。</p>

<ol>
<li>如果 vm.overcommit_memory = 1，直接放行。</li>
<li>vm.overcommit_memory = 0：则比较此次请求分配的虚拟内存大小和系统当前空闲的物理内存加上swap，决定是否放行。</li>
<li>vm.overcommit_memory = 2：则会比较 进程所有已分配的虚拟内存加上此次请求分配的虚拟内存和系统当前的空闲物理内存加上 swap，决定是否放行。</li>
</ol>

<p>如图提示这个错误：</p>

<p>[13223] 17 Mar 13:18:02.207 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#8216;vm.overcommit_memory = 1&#8217; to /etc/sysctl.conf and then reboot or run the command &#8216;sysctl vm.overcommit_memory=1&#8217; for this to take effect.</p>

<p>错误提示明确说明了解决办法，也是设置 vm.overcommit_memory=1.</p>

<h3 id="redis内核参数overcommit-memory"><strong>Redis内核参数overcommit_memory</strong></h3>

<p>它是内存分配策略可选值：0、1、2。</p>

<ul>
<li>0表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。</li>
<li>1表示内核允许分配所有的物理内存，而不管当前的内存状态如何。</li>
<li>2表示内核允许分配超过所有物理内存和交换空间总和的内存</li>
</ul>

<h3 id="有用的链接">有用的链接</h3>

<ul>
<li><a href="http://blog.csdn.net/whycold/article/details/21388455" target="_blank" rel="nofollow">内核参数overcommit_memory说明</a></li>
<li><a href="http://www.redicecn.com/html/Linux/20131125/468.html" target="_blank" rel="nofollow">MISCONF Redis is configured to save RDB snapshots问题的解决</a></li>
<li><a href="http://www.linuxidc.com/Linux/2012-07/66079.htm" target="_blank" rel="nofollow">从Redis的数据丢失说起</a></li>
</ul>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

