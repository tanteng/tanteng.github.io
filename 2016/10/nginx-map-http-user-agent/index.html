<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.55.6" />

    
    
    

<title>使用 Nginx map 指令匹配 User Agent 自定义值 • 小谈博客</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 Nginx map 指令匹配 User Agent 自定义值"/>
<meta name="twitter:description" content="本文介绍有关 User-Agent 的知识，以及使用 Nginx map 指令配合正则表达式匹配 User Agent 自定义值，通过捕获 UA 自定义值，可以做很多事情，其中一个场景是：让一台测试机支持多个测试同时测试一个项目，原理就是匹配 UA 值，设置不同的 WEB 根目录。"/>

<meta property="og:title" content="使用 Nginx map 指令匹配 User Agent 自定义值" />
<meta property="og:description" content="本文介绍有关 User-Agent 的知识，以及使用 Nginx map 指令配合正则表达式匹配 User Agent 自定义值，通过捕获 UA 自定义值，可以做很多事情，其中一个场景是：让一台测试机支持多个测试同时测试一个项目，原理就是匹配 UA 值，设置不同的 WEB 根目录。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://tanteng.me/2016/10/nginx-map-http-user-agent/" />
<meta property="article:published_time" content="2016-10-10T07:02:22&#43;00:00"/>
<meta property="article:modified_time" content="2016-10-10T07:02:22&#43;00:00"/>


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.5908340ec0d0531feb30d45d7ab9a057fcd461f5bda26b1c817b70b1565424bb.css" integrity="sha256-WQg0DsDQUx/rMNRdermgV/zUYfW9omscgXtwsVZUJLs=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="http://tanteng.me/">小谈博客</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="http://tanteng.me/img/avatar.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         一个专注 WEB 技术的博客 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">小谈博客</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	
	<a href="https://facebook.com/tanteng001" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/tanteng" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	<a href="https://instagram.com/tanteng1031" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/tanteng" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 TonyTan
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>使用 Nginx map 指令匹配 User Agent 自定义值</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Oct 10, 2016
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  <div class="post">
    <p>本文介绍有关 User-Agent 的知识，以及使用 Nginx map 指令配合正则表达式匹配 User Agent 自定义值，通过捕获 UA 自定义值，可以做很多事情，其中一个场景是：让一台测试机支持多个测试同时测试一个项目，原理就是匹配 UA 值，设置不同的 WEB 根目录。</p>

<h3 id="关于-user-agent">关于 User Agent</h3>

<blockquote>
<p>User Agent 中文名为用户代理，简称 UA，它是一个特殊字符串头，使得服务器能够识别客户使用的操作系统及版本、CPU 类型、浏览器及版本、浏览器渲染引擎、浏览器语言、浏览器插件等。</p>
</blockquote>

<p>用 Firefox的 Firebug 工具可以看到每次请求的请求头信息都包含 User-Agent 字段，如图所示：</p>

<p><a href="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-modifiy.png" target="_blank" rel="nofollow"><img class="alignnone" src="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-modifiy.png" width="1207" height="245" /></a></p>

<p>通过查看 nginx 的请求日志如 access.log，也可以查看到每次请求的 UA 信息，如果是 curl 命令方式请求，可以看到 UA 信息是 curl：</p>

<p><span style="color: #808080;">192.168.10.1 &#8211; &#8211; [10/Oct/2016:02:42:59 +0000] &#8220;GET /hello HTTP/1.1&#8221; 200 18 &#8220;-&#8221; &#8220;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0 tanteng&#8221;</span></p>

<p><span style="color: #808080;">127.0.0.1 &#8211; &#8211; [10/Oct/2016:02:43:23 +0000] &#8220;GET /hello HTTP/1.1&#8221; 200 22 &#8220;-&#8221; &#8220;curl/7.35.0&#8221;</span></p>

<h3 id="firefox-插件-user-agent-switcher">Firefox 插件：User Agent Switcher</h3>

<p>这个插件可以管理和切换不同的 User-Agent，比如模拟不同的浏览器，或者新增自定义的 UA，可以在 UA 中带上自己的标识。</p>

<p>比如新增一个自己的 UA，并加上自己的标识，如图：</p>

<p><a href="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-tanteng.png" target="_blank" rel="nofollow"><img class="alignnone" src="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-tanteng.png" width="838" height="543" /></a></p>

<p>这样 Firefox 发出的请求头信息中 UA 就是这个修改过后的，访问一个本地 WEB 项目，通过 firebug 或查看 nginx 的 access.log 日志，都可以发现请求 UA 发生了变化。</p>

<p><a href="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-access-log.png" target="_blank" rel="nofollow"><img class="alignnone" src="https://oddgb63aa.qnssl.com/uploads/2016/10/user-agent-access-log.png" width="1557" height="181" /></a></p>

<h3 id="nginx-配置匹配-user-agent">Nginx 配置匹配 User-Agent</h3>

<p>在 nginx 配置文件中，$http_user_agent 表示 UA 的值，比如浏览器默认 UA 值是：</p>

<p>Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0</p>

<p>现在新增了一个 UA，UA 值是在后面加一个空格和名字，如：</p>

<p>Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0 tanteng</p>

<p>通过 Firefox 的 User Agent Swicher 这个插件切换到新的 UA，再通过浏览器访问，UA 就是这个修改之后的。</p>

<p><strong>那么，在 nginx 中如何匹配这个最后的名字呢？</strong>这里可以用到 nginx 的 map 指令配合正则表达式。</p>

<h4 id="map-指令正则匹配">map 指令正则匹配</h4>

<blockquote>
<p>map 指令使用 ngx_http_map_module 模块提供的，ngx_http_map_module 模块可以创建变量，这些变量的值与另外的变量值相关联。允许分类或者同时映射多个值到多个不同值并储存到一个变量中，map 指令用来创建变量，但是仅在变量被接受的时候执行视图映射操作，对于处理没有引用变量的请求时，这个模块并没有性能上的缺失。</p>
</blockquote>

<p><strong>在 nginx 的 http 域中，增加以下代码：</strong></p>

<p><code>map $http_user_agent $user {
    default            &ldquo;;
    ~curl              curl;
    ~(?&lt;name&gt;[\S]+$)   $name;
}</code></p>

<p>这里正则表达式 [\S]+$ 即匹配最后一个非空白字符，?<name> 表示要匹配的结果用 $name 表示。</p>

<p>这个 map 域的意思是，匹配对象是 $http_user_agent，即 UA，默认 $user 值是空字符串，如果是 curl 开头的，$user 值就是 curl，如果可以匹配到最后一个非空字符串，那么 $user 的值就是这个最后的字符串。</p>

<p><strong>在 server 域中添加如下测试代码：</strong></p>

<p><code class="lang:php decode:true ">location /hello {
    echo http_user_agent:$http_user_agent;
    echo user:$user;
}</code></p>

<p>执行 curl 命令：curl www.tanteng.me/hello</p>

<p>返回结果：</p>

<p><span style="color: #808080;">http_user_agent:curl/7.35.0</span></p>

<p><span style="color: #808080;">user:curl</span></p>

<p>在浏览器中访问，输出结果是：</p>

<p><span style="color: #808080;">http_user_agent:Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0 tanteng</span></p>

<p><span style="color: #808080;">user:tanteng</span></p>

<p>这样就成功获取到 UA 后面增加的一个值。</p>

<h3 id="nginx-根据不同的-ua-设置网站根目录">Nginx 根据不同的 UA 设置网站根目录</h3>

<p>通过 map 指令获取到 UA 自定义值后，可以做如下设置，让不同的测试人员对应不同的网站根目录：</p>

<p><code class="lang:php mark:3 decode:true">location ~ .php$ {
    try_files      $uri =404;
    root           /usr/share/nginx/html/$user/public;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
}</code></p>

<p class="lang:php mark:3 decode:true ">
  这里 root 行，网站目录可以用 $user 变量来表示。比如测试人员 ruike,他修改自己的 UA 后面加上 ruike，那么访问的网站根目录是 /usr/share/nginx/html/ruike/public，这样不同的测试人员在自己的各自目录拉取代码，互不影响，支持同时进行测试。
</p>

<p class="lang:php mark:3 decode:true ">
  测试一下效果，把 public 下的 index.php 文件前面用 echo &#8216;wo shi ruike.&#8217;;exit; 输出。
</p>

<p class="lang:php mark:3 decode:true ">
  切换到 ruike 这个 UA，访问网站，显示的即是以上内容，切换回 tanteng 这个 UA，显示的是正常的网站内容，这就达到了通过 UA 自定义值设置不同的网站根目录的效果，也就支持了一台测试机支持不同的测试人员同时进行测试的需求。
</p>

<p>（本文小谈博客原创，转载请注明出处：<a href="https://blog.tanteng.me/2016/10/nginx-map-http-user-agent/" target="_blank"><a href="https://blog.tanteng.me/2016/10/nginx-map-http-user-agent/">https://blog.tanteng.me/2016/10/nginx-map-http-user-agent/</a></a>）</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2016/10/laravel-session-middleware/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Laravel Session 保存机制和 terminate 中间件</span>
    </a>
    
    
    <a href="/2016/10/nginx-map-redirect/" class="navigation-next">
      <span class="navigation-tittle">使用 Nginx map 指令实现页面重定向</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script src="https://cdn.bootcss.com/font-awesome/5.5.0/js/all.min.js"></script>

    
    
        <script src="https://cdn.bootcss.com/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
