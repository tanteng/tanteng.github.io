<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.55.6" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PHP数组同值稳定排序 &middot; 小谈博客</title>

  
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://tanteng.github.io/"><h1>小谈博客</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://tanteng.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>PHP数组同值稳定排序</h1>
  <time datetime=2016-11-16T15:54:43Z class="post-date">Wed, Nov 16, 2016</time>
  <p>在 PHP 中对数组排序有很多函数，如 sort, asort, arsort, ksort, krsort, uasort 等等，但是有一个问题，如一个数组：</p>

<pre class="lang:php decode:true ">$test = array(1 =&gt; 0, 99 =&gt; 0, 87 =&gt; 0, 45 =&gt; 0, 67 =&gt; 0, 11 =&gt; 1, 2 =&gt; 0);</pre>

<p>用 asort 函数对其进行排序，asort($test) 结果如下（转换为 json 格式）：</p>

<pre class="lang:php decode:true ">{"67":0,"2":0,"1":0,"45":0,"87":0,"99":0,"11":1}</pre>

<p>可以看到排序虽然正确，值为 1 的元素排到后面去了，但是值为 0 的元素顺序跟以前不一样了，如何保证 PHP 数组同值元素排序后顺序保持不变呢？</p>

<p>感谢网友的回答：</p>

<blockquote>
<p>PHP 的 asort 和 sort，底层是用快排实现的。无法保证同等大小的元素的顺序。要保证值为0的顺序不变？只能自己实现一个数组排序。对于数组中相等的元素，它们在排序后的顺序是未定义的。 （也即相等元素之间的顺序是不稳定的）</p>
</blockquote>

<h3 id="解决方法">解决方法</h3>

<p>1.在 PHP 官方手册上其实有答案了，直接贴出来：</p>

<p>If you want to keep the order when two members compare as equal, use this.</p>

<pre class="lang:php decode:true ">&lt;?php

function stable_uasort(&$array, $cmp_function) {
    if(count($array) &lt; 2) {
        return;
    }
    $halfway = count($array) / 2;
    $array1 = array_slice($array, 0, $halfway, TRUE);
    $array2 = array_slice($array, $halfway, NULL, TRUE);

    stable_uasort($array1, $cmp_function);
    stable_uasort($array2, $cmp_function);
    if(call_user_func($cmp_function, end($array1), reset($array2)) &lt; 1) {
        $array = $array1 + $array2;
        return;
    }
    $array = array();
    reset($array1);
    reset($array2);
    while(current($array1) && current($array2)) {
        if(call_user_func($cmp_function, current($array1), current($array2)) &lt; 1) {
            $array[key($array1)] = current($array1);
            next($array1);
        } else {
            $array[key($array2)] = current($array2);
            next($array2);
        }
    }
    while(current($array1)) {
        $array[key($array1)] = current($array1);
        next($array1);
    }
    while(current($array2)) {
        $array[key($array2)] = current($array2);
        next($array2);
    }
    return;
}

function cmp($a, $b) {
    if($a['n'] == $b['n']) {
        return 0;
    }
    return ($a['n'] &gt; $b['n']) ? -1 : 1;
}

$a = $b = array(
    'a' =&gt; array("l" =&gt; "A", "n" =&gt; 1),
    'b' =&gt; array("l" =&gt; "B", "n" =&gt; 2),
    'c' =&gt; array("l" =&gt; "C", "n" =&gt; 1),
    'd' =&gt; array("l" =&gt; "D", "n" =&gt; 2),
    'e' =&gt; array("l" =&gt; "E", "n" =&gt; 2),
);

uasort($a, 'cmp');
print_r($a);

stable_uasort($b, 'cmp');
print_r($b);
?&gt;</pre>

<ol>
<li>如果使用 Composer，也可以使用 PHP 扩展包，这里有一个扩展包 vanderlee/php-stable-sort-functions 就是专门解决这个问题的。</li>
</ol>

<pre class="lang:php decode:true ">bool StableSort::arsort ( array &$array [, int $sort_flags = SORT_REGULAR ] )
bool StableSort::asort ( array &$array [, int $sort_flags = SORT_REGULAR ] )
bool StableSort::natcasesort ( array &Sarray )
bool StableSort::natsort ( array &Sarray )
bool StableSort::uasort ( array &$array , callable $value_compare_func )
bool StableSort::uksort ( array &$array , callable $value_compare_func )
bool StableSort::usort ( array &$array , callable $value_compare_func )</pre>

<h4 id="推荐链接">推荐链接</h4>

<ul>
<li>扩展包地址：<a href="https://packagist.org/packages/vanderlee/php-stable-sort-functions" target="_blank" rel="nofollow"><a href="https://packagist.org/packages/vanderlee/php-stable-sort-functions">https://packagist.org/packages/vanderlee/php-stable-sort-functions</a></a></li>
<li><a href="https://segmentfault.com/q/1010000007492504?_ea=1362649" target="_blank" rel="nofollow"><a href="https://segmentfault.com/q/1010000007492504?_ea=1362649">https://segmentfault.com/q/1010000007492504?_ea=1362649</a></a><section></li>
</ul>

<p><div>
</div></section></p>
</div>


    </main>

    
  </body>
</html>
