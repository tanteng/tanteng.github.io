<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Laravel 使用 env 读取环境变量为 null 的问题 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Laravel 使用 env 读取环境变量为 null 的问题</h1>
    <span class="post-date">Dec 4, 2016 &middot; 1 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/laravel">Laravel</a><a class="label" href="http://tanteng.me/categories/php">PHP</a>
    </span>
    <p>不知道大家有没有遇到过，在 Laravel 中（除 app/config 目录下的配置文件中）使用 env 函数读取环境变量，有时有用，有时返回 null，究竟怎么回事？让我们一探究竟。</p>

<p>在 Laravel 项目中，如果执行了 php artisan config:cache 命令把配置文件缓存起来后，在 Tinker 中（Tinker 是 Laravel 自带的一个交互式命令行界面），使用 env 函数读取环境变量的值为 null，只有执行 php artisan config:clear 清除配置缓存后就可以读取了，这是为什么呢？</p>

<p>打开 .env 文件看，这些都是有值的：</p>

<pre class="lang:php decode:true">APP_ENV=local
APP_KEY=base64:JHE5bOkRg283uT0n1Zq/GgvGEer8ooYiB42/wIcCyvo=
APP_DEBUG=true
APP_LOG_LEVEL=debug
APP_URL=http://www.tanteng.me

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=tanteng.me
DB_USERNAME=homestead
DB_PASSWORD=secret</pre>

<p>如图所示：</p>

<p><img class="alignnone size-full wp-image-11103" src="https://blog.tanteng.me/wp-content/uploads/2016/12/laravel-env.png" alt="laravel-env" width="1000" height="672" /></p>

<h3 id="原因何在">原因何在？</h3>

<p>在 Laravel 中，如果执行 php aritisan config:cache 命令，Laravel 将会把 app/config 目录下的所有配置文件“编译”整合成一个缓存配置文件到  bootstrap/cache/config.php，每个配置文件都可以通过 env 函数读取环境变量，这里是可以读取的。但是一旦有了这个缓存配置文件，在其他地方使用 env 函数是读取不到环境变量的，所以返回 null.</p>

<p>让我们看看这段代码，Illuminate/Foundation/Bootstrap/DetectEnvironment.php line 18：</p>

<pre class="lang:php decode:true">public function bootstrap(Application $app)
{
    if (! $app-&gt;configurationIsCached()) {
        $this-&gt;checkForSpecificEnvironmentFile($app);

        try {
            (new Dotenv($app-&gt;environmentPath(), $app-&gt;environmentFile()))-&gt;load();
        } catch (InvalidPathException $e) {
            //
        }
    }
}</pre>

<p>这个方法在框架启动后就会运行，这段代码说明了如果存在缓存配置文件，就不会去设置环境变量了，配置都读缓存配置文件，而不会再读环境变量了。</p>

<p>因此，在配置文件即 app/config 目录下的其他地方，读取配置不要使用 env 函数去读环境变量，这样你一旦执行 php artisan config:cache 之后，env 函数就不起作用了。所有要用到的环境变量，在 app/config 目录的配置文件中通过 env 读取，其他地方要用到环境变量的都统一读配置文件而不是使用 env 函数读取。</p>

<p>这个问题以前遇到过后来改了写法，在 github 上一个扩展包中发现一个 bug，发现也是这个问题导致的，跟作者反馈也确认这一点。</p>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

