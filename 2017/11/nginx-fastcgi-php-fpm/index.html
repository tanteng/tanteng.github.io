<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>PHP-FPM,Nginx,FastCGI 之间的关系 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">PHP-FPM,Nginx,FastCGI 之间的关系</h1>
    <span class="post-date">Nov 9, 2017 &middot; 1 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/php">PHP</a><a class="label" href="http://tanteng.me/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8">服务器</a>
    </span>
    <p>本文介绍 PHP-FPM,Nginx,FastCGI 三者之间的关系，以及 Nginx 反向代理和负载均衡的配置。</p>

<h3 id="php-fpm-nginx-fastcgi-之间的关系">PHP-FPM,Nginx,FastCGI 之间的关系</h3>

<p>FastCGI 是一个协议，它是应用程序和 WEB 服务器连接的桥梁。Nginx 并不能直接与 PHP-FPM 通信，而是将请求通过 FastCGI 交给 PHP-FPM 处理。</p>

<pre class="lang:default decode:true">location ~ \.php$ {
    try_files $uri /index.php =404;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}</pre>

<p>这里 fastcgi_pass 就是把所有 php 请求转发给 php-fpm 进行处理。通过 netstat 命令可以看到，127.0.0.1:9000 这个端口上运行的进程就是 php-fpm.</p>

<p><a href="https://blog.tanteng.me/wp-content/uploads/2017/11/php-fpm.png" target="_blank" rel="noopener"><img class="alignnone wp-image-11721 size-full" src="https://blog.tanteng.me/wp-content/uploads/2017/11/php-fpm.png" alt="" width="1192" height="620" /></a></p>

<h3 id="nginx-反向代理">Nginx 反向代理</h3>

<p>Nginx 反向代理最重要的指令是 proxy_pass，如：</p>

<pre class="lang:default decode:true ">location ^~ /seckill_query/ {
    proxy_pass http://ris.filemail.gdrive:8090/;
    proxy_set_header Host ris.filemail.gdrive;
}

location ^~ /push_message/ {
    proxy_pass http://channel.filemail.gdrive:8090/;
    proxy_set_header Host channel.filemail.gdrive;
}

location ^~ /data/ {
    proxy_pass http://ds.filemail.gdrive:8087/;
    proxy_set_header Host ds.filemail.gdrive;
}</pre>

<p>通过 location 匹配 url 路径，将其转发到另外一个服务器处理。</p>

<p>通过负载均衡 upstream 也可以实现反向代理。</p>

<h3 id="nginx-负载均衡">Nginx 负载均衡</h3>

<p>介绍一下 upstream 模块：</p>

<blockquote>
<p>负载均衡模块用于从”upstream”指令定义的后端主机列表中选取一台主机。nginx先使用负载均衡模块找到一台主机，再使用upstream模块实现与这台主机的交互。</p>
</blockquote>

<p>负载均衡配置：</p>

<pre class="lang:default decode:true">upstream php-upstream {
    ip_hash;

    server 192.168.0.1;
    server 192.168.0.2;
}

location / {
    root   html;
    index  index.html index.htm;
    proxy_pass http://php-upstream;
}</pre>

<p>该例定义了一个 php-upstream 的负载均衡配置，通过 proxy_pass 反向代理指令应用这个配置。这里用的 ip_hash 算法，负载均衡的算法有多种，就不一一列举了。</p>

<p><strong>负载均衡也可以用在 fastcgi_pass 上。</strong></p>

<p>如：</p>

<pre class="lang:default decode:true">fastcgi_pass http://php-upstream</pre>

<p>如果使用负载均衡，可能存在一个 session 失效的问题，你的每次请求可能分配到不同的服务器，一个解决方法是把 Memcached 或 Redis 作为 session 存储的方式，而且还可以提高性能。</p>

<h4 id="反向代理和负载均衡是什么关系">反向代理和负载均衡是什么关系</h4>

<p>反向代理和负载均衡这两个词经常出现在一起，但他们实际上是不同的概念，负载均衡它更多的是强调的是一种算法或策略，将请求分布到不同的机器上，因此实际上也起到了反向代理的作用。</p>

<h4 id="proxy-pass-和-fastcgi-pass-的区别">proxy_pass 和 fastcgi_pass 的区别</h4>

<p>一个是反向代理模块，一个是转发给 factcgi 后端处理。</p>

<p><img class="alignnone size-full wp-image-11724" src="https://blog.tanteng.me/wp-content/uploads/2017/11/20150517221800380.jpg" alt="" width="710" height="234" /></p>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

