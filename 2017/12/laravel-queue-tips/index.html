<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.55.6" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>使用 Laravel 消息队列要注意的问题 &middot; 小谈博客</title>

  
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://tanteng.github.io/css/hyde.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://tanteng.github.io/"><h1>小谈博客</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://tanteng.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>使用 Laravel 消息队列要注意的问题</h1>
  <time datetime=2017-12-11T10:08:13Z class="post-date">Mon, Dec 11, 2017</time>
  <p>使用 Laravel 的消息队列处理异步任务，Redis 作为队列数据库，Supervisor 监控脚本异常中断并自动重启，这是 Laravel 处理队列任务的标准流程，但是实际中可能还会出现各种各样的问题，为了保证系统<strong>可靠性</strong>，还要注意几个问题。</p>

<h3 id="一-执行失败重试次数设置">一、执行失败重试次数设置</h3>

<p>一定要设置任务执行失败重试次数，避免无限失败重试，超过重试次数 Laravel 会默认写到失败任务表中，也可以自己写执行失败后续处理逻辑。</p>

<pre class="lang:php decode:true">php artisan queue:work redis --tries=3</pre>

<p>需要先执行以下命令创建数据表：</p>

<pre class="lang:php decode:true">php artisan queue:failed-table

php artisan migrate</pre>

<h3 id="二-程序异常的处理">二、程序异常的处理</h3>

<p>有时候程序执行过程会发生异常，比如依赖其他接口，请求 HTTP 接口超时等等，如果不捕捉异常，那么当前这个队列就会中断不能继续运行下去，比如给 10000 个用户推送内容，需要依赖接口推送，如果中间的请求挂了就会影响到后面的推送。</p>

<p>这里的异常是指程序执行过程中发生的异常，不是指常驻进程挂掉，程序异常不一定导致常驻进程中断，况且进程中断有 Supervisor 监控并重启。</p>

<p>如捕获异常代码片段：</p>

<pre class="lang:php decode:true">try {
    $r = $client-&gt;request('POST', '', [
        'query' =&gt; [
            'client_name'     =&gt; 'filemail',
            'client_version'  =&gt; '1.0',
            'client_sequence' =&gt; 0,
            'uid'             =&gt; 692934013,//119481237
            'r'               =&gt; 1508312484,
        ],
        'body'  =&gt; \GuzzleHttp\json_encode($body),
    ]);
    $result = $r-&gt;getBody()-&gt;getContents();
    $result = json_decode($result, true);
    if ($result['result'] == 0) {
        info("sendMail fail:" . json_encode($result));
        $this-&gt;pushLog($task['id'], $task['mail_id'], implode(',', $userIds), json_encode($result), 0);
    } else {
        Log::warning("sendMail fail:" . json_encode($result));
        $this-&gt;pushLog($task['id'], $task['mail_id'], implode(',', $userIds), json_encode($result), $result['result']);
    }
} catch (RequestException $e) {
    Log::warning('RequestException' . $e-&gt;getMessage());
} catch (Exception $e) {
    Log::emergency('Exception' . $e-&gt;getMessage());
}</pre>

<h3 id="三-修改代码记得重启-supervisor">三、修改代码记得重启 Supervisor</h3>

<p>最后一点，修改了处理队列的程序，记得要重启 Supervisor，否则脚本不会生效。</p>

<h3 id="laravel-往-redis-写队列的数据结构">Laravel 往 Redis 写队列的数据结构</h3>

<p>队列用 list 类型存储，如图：</p>

<p><img class="alignnone size-full wp-image-11850" src="https://blog.tanteng.me/wp-content/uploads/2017/12/queue_20171212135639.png" alt="" width="555" height="264" /></p>

<p>value 内容如下：</p>

<pre class="lang:php decode:true ">{
  "job": "Illuminate\\Queue\\CallQueuedHandler@call",
  "data": {
    "commandName": "App\\Jobs\\SendFile",
    "command": "O:17:\"App\\Jobs\\SendFile\":5:{s:23:\"\u0000App\\Jobs\\SendFile\u0000task\";a:8:{s:5:\"title\";s:4:\"1111\";s:4:\"note\";s:2:\"11\";s:6:\"reward\";s:0:\"\";s:7:\"mail_id\";s:5:\"66681\";s:4:\"nums\";i:20;s:8:\"uid_file\";s:33:\"uidfile\/file-66681-1513058185.txt\";s:5:\"gcids\";s:40:\"1B9DD95645AAE8119F7DA9B9FF738D52BC8A1BD5\";s:2:\"id\";i:29;}s:6:\"\u0000*\u0000job\";N;s:10:\"connection\";N;s:5:\"queue\";s:8:\"sendfile\";s:5:\"delay\";N;}"
  },
  "id": "l0mjsUthbxm4TgIJNUH13km9N8DIpErK",
  "attempts": 1
}</pre>

<p>包含失败重试次数，队列标识，处理队列的类，以及队列的数据等等。</p>

<h3 id="参考链接">参考链接</h3>

<p>Laravel 官方文档 Queue 队列：</p>

<p><a href="https://laravel.com/docs/5.5/queues" target="_blank" rel="noopener nofollow"><a href="https://laravel.com/docs/5.5/queues">https://laravel.com/docs/5.5/queues</a></a></p>
</div>


    </main>

    
  </body>
</html>
