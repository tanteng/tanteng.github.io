<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>使用 Laravel 消息队列要注意的问题 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">使用 Laravel 消息队列要注意的问题</h1>
    <span class="post-date">Dec 11, 2017 &middot; 1 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/laravel">Laravel</a><a class="label" href="http://tanteng.me/categories/php">PHP</a>
    </span>
    <p>使用 Laravel 的消息队列处理异步任务，Redis 作为队列数据库，Supervisor 监控脚本异常中断并自动重启，这是 Laravel 处理队列任务的标准流程，但是实际中可能还会出现各种各样的问题，为了保证系统<strong>可靠性</strong>，还要注意几个问题。</p>

<h3 id="一-执行失败重试次数设置">一、执行失败重试次数设置</h3>

<p>一定要设置任务执行失败重试次数，避免无限失败重试，超过重试次数 Laravel 会默认写到失败任务表中，也可以自己写执行失败后续处理逻辑。</p>

<pre class="lang:php decode:true">php artisan queue:work redis --tries=3</pre>

<p>需要先执行以下命令创建数据表：</p>

<pre class="lang:php decode:true">php artisan queue:failed-table

php artisan migrate</pre>

<h3 id="二-程序异常的处理">二、程序异常的处理</h3>

<p>有时候程序执行过程会发生异常，比如依赖其他接口，请求 HTTP 接口超时等等，如果不捕捉异常，那么当前这个队列就会中断不能继续运行下去，比如给 10000 个用户推送内容，需要依赖接口推送，如果中间的请求挂了就会影响到后面的推送。</p>

<p>这里的异常是指程序执行过程中发生的异常，不是指常驻进程挂掉，程序异常不一定导致常驻进程中断，况且进程中断有 Supervisor 监控并重启。</p>

<p>如捕获异常代码片段：</p>

<pre class="lang:php decode:true">try {
    $r = $client-&gt;request('POST', '', [
        'query' =&gt; [
            'client_name'     =&gt; 'filemail',
            'client_version'  =&gt; '1.0',
            'client_sequence' =&gt; 0,
            'uid'             =&gt; 692934013,//119481237
            'r'               =&gt; 1508312484,
        ],
        'body'  =&gt; \GuzzleHttp\json_encode($body),
    ]);
    $result = $r-&gt;getBody()-&gt;getContents();
    $result = json_decode($result, true);
    if ($result['result'] == 0) {
        info("sendMail fail:" . json_encode($result));
        $this-&gt;pushLog($task['id'], $task['mail_id'], implode(',', $userIds), json_encode($result), 0);
    } else {
        Log::warning("sendMail fail:" . json_encode($result));
        $this-&gt;pushLog($task['id'], $task['mail_id'], implode(',', $userIds), json_encode($result), $result['result']);
    }
} catch (RequestException $e) {
    Log::warning('RequestException' . $e-&gt;getMessage());
} catch (Exception $e) {
    Log::emergency('Exception' . $e-&gt;getMessage());
}</pre>

<h3 id="三-修改代码记得重启-supervisor">三、修改代码记得重启 Supervisor</h3>

<p>最后一点，修改了处理队列的程序，记得要重启 Supervisor，否则脚本不会生效。</p>

<h3 id="laravel-往-redis-写队列的数据结构">Laravel 往 Redis 写队列的数据结构</h3>

<p>队列用 list 类型存储，如图：</p>

<p><img class="alignnone size-full wp-image-11850" src="https://blog.tanteng.me/wp-content/uploads/2017/12/queue_20171212135639.png" alt="" width="555" height="264" /></p>

<p>value 内容如下：</p>

<pre class="lang:php decode:true ">{
  "job": "Illuminate\\Queue\\CallQueuedHandler@call",
  "data": {
    "commandName": "App\\Jobs\\SendFile",
    "command": "O:17:\"App\\Jobs\\SendFile\":5:{s:23:\"\u0000App\\Jobs\\SendFile\u0000task\";a:8:{s:5:\"title\";s:4:\"1111\";s:4:\"note\";s:2:\"11\";s:6:\"reward\";s:0:\"\";s:7:\"mail_id\";s:5:\"66681\";s:4:\"nums\";i:20;s:8:\"uid_file\";s:33:\"uidfile\/file-66681-1513058185.txt\";s:5:\"gcids\";s:40:\"1B9DD95645AAE8119F7DA9B9FF738D52BC8A1BD5\";s:2:\"id\";i:29;}s:6:\"\u0000*\u0000job\";N;s:10:\"connection\";N;s:5:\"queue\";s:8:\"sendfile\";s:5:\"delay\";N;}"
  },
  "id": "l0mjsUthbxm4TgIJNUH13km9N8DIpErK",
  "attempts": 1
}</pre>

<p>包含失败重试次数，队列标识，处理队列的类，以及队列的数据等等。</p>

<h3 id="参考链接">参考链接</h3>

<p>Laravel 官方文档 Queue 队列：</p>

<p><a href="https://laravel.com/docs/5.5/queues" target="_blank" rel="noopener nofollow"><a href="https://laravel.com/docs/5.5/queues">https://laravel.com/docs/5.5/queues</a></a></p>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

