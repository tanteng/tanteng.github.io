<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>在 Laravel 中使用 DataTables 插件 &middot; TonyTan</title>

  
  <link rel="stylesheet" href="http://tanteng.me/css/poole.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde.css">
  <link rel="stylesheet" href="http://tanteng.me/css/poole-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://tanteng.me/css/hyde-x.css">
  <link rel="stylesheet" href="http://tanteng.me/css/highlight/sunburst.css">
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://tanteng.me/touch-icon-144-precomposed.png">
  <link href="http://tanteng.me/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
</head>
<body class="theme-base-0d">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://tanteng.me/"><h1>小谈博客</h1></a>
      <p class="lead">
       一个专注WEB技术的博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://tanteng.me/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/tanteng"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/tanteng"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://www.instagram.com/tanteng1031"><i class="fa fa-instagram fa-3x"></i></a>
      <a href="https://www.facebook.com/tanteng001"><i class="fa fa-facebook-square fa-3x"></i></a>
      
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2019 <a href="http://tanteng.me/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">在 Laravel 中使用 DataTables 插件</h1>
    <span class="post-date">May 28, 2018 &middot; 3 minute read
    
    <br/>
    <a class="label" href="http://tanteng.me/categories/develop">Develop</a><a class="label" href="http://tanteng.me/categories/%E5%89%8D%E7%AB%AF">前端</a>
    </span>
    <p>DataTables 是一个 jQuery 的表格插件，记录一下在 Laravel 中使用的常用功能和用法，比如 ajax 获取数据，自定义搜索，效果展现，选项说明等等，有一些细节记录下来方便以后查看。</p>

<h3 id="laravel-控制器方法">Laravel 控制器方法</h3>

<p>接受 ajax get 请求，返回数据。</p>

<p>dataTables 会自带一些参数过来，需要按照格式返回数据，比如分页等。见 dataTables 官方文档说明。</p>

<p>代码如下：</p>

<pre class="lang:php decode:true ">// ajax GET 获取列表数据
public function getList(Request $request)
{
    $dynamicType = $request-&gt;get('dynamic_type');
    $draw = $request-&gt;get('draw');
    $start = $request-&gt;get('start');
    $length = $request-&gt;get('length');
    $groupId = $request-&gt;get('group_id');
    $dynamicId = $request-&gt;get('dynamic_id');
    $userid = $request-&gt;get('userid');
    $isAudit = $request-&gt;get('is_audit', 0);

    if (!$dynamicType || !in_array($dynamicType, [1, 2])) {
        return response()-&gt;json(['error' =&gt; '缺少参数！']);
    }

    $builder = Dynamics::select(['id', 'userid', 'group_id', 'dynamic_id', 'dynamic_type', 'content', 'money', 'is_audit', 'audited_at'])-&gt;where('dynamic_type', $dynamicType);

    //自定义搜索
    if ($groupId) {
        $builder-&gt;where('group_id', $groupId);
    }

    if ($dynamicId) {
        $builder-&gt;where('dynamic_id', $dynamicId);
    }

    if ($userid) {
        $builder-&gt;where('userid', $userid);
    }

    if (!is_null($isAudit)) {
        $builder-&gt;where('is_audit', $isAudit);
    }

    $total = $builder-&gt;count();
    $list = $builder-&gt;orderBy('id', 'desc')-&gt;offset($start)-&gt;take($length)-&gt;get()-&gt;toArray();


    $imgInfo = [];
    $dynamicIds = $this-&gt;getDynamicIds($list);
    if ($dynamicIds) {
        $imgInfo = DynamicImage::whereIn('dynamic_id', $dynamicIds)-&gt;pluck('images', 'dynamic_id');
    }

    $fillImages = function ($item) use ($imgInfo) {
        if (isset($imgInfo[$item['dynamic_id']])) {
            $item["images"] = json_decode($imgInfo[$item['dynamic_id']]);
        } else {
            $item["images"] = [];
        }
        return $item;
    };
    $list = array_map($fillImages, $list);

    $data = [];
    $data["draw"] = $draw;
    $data["recordsTotal"] = $total;
    $data["recordsFiltered"] = $total;
    $data["data"] = $list;
    return response()-&gt;json($data);
}</pre>

<h3 id="datatables-发-ajax-请求及一些选项设置">dataTables 发 ajax 请求及一些选项设置</h3>

<p>columnDefs 用来自定义每个字段如何展现，可以封装自己的展现逻辑，也可以获取到这一行各个字段的值。</p>

<p>createdRow 可以改变创建每一行的行为，比如修改这一行的样式等等。</p>

<p>table.draw() 方法可以重新发起 ajax 请求。</p>

<pre class="lang:js decode:true">&lt;script type="text/javascript"&gt;
    $dataTable = $("#dataTable");
    var table = $dataTable.DataTable({
        "processing": true,
        "serverSide": true,
        "pageLength": 25,
        "lengthMenu": [10, 25, 50, 75, 100, 200],
        "ajax": {
            "url": "{{ route('audit.getList') }}",
            "data": function (data) {
                data.dynamic_type = "{{ Request::get('dynamic_type', 1) }}";
                data.group_id = $("#group_id").val();
                data.dynamic_id = $("#dynamic_id").val();
                data.userid = $("#userid").val();
                data.is_audit = $("#is_audit").val();
                data.t = "{{ time() }}";
            }
        },
        "columns": [
            {"data": "id"},
            {"data": "userid"},
            {"data": "group_id"},
            {"data": "dynamic_type"},
            {"data": "dynamic_id"},
            {"data": "content"},
            {"data": "images"},
            {"data": "money"},
            {"data": "is_audit"},
            {"data": "audited_at"}
        ],
        "columnDefs": [
            {
                "render": function (data, type, row) {
                    if (data == 1) {
                        return "活动";
                    } else if (data == 2) {
                        return "动态";
                    }
                },
                "targets": 3
            },
            {
                "render": function (data, type, row) {
                    html = "";
                    $.each(data, function (k, v) {
                        html += "&lt;a href='" + v.origin + "' target='_blank'&gt;&lt;img src='" + v.origin + "' width='160' style='margin-bottom: 2px;'&gt;";
                    });
                    return html;
                },
                "targets": 6
            },
            {
                "render": function (data, type, row) {
                    if (data == 0) {
                        return "未审核";
                    } else if (data == 1) {
                        return "审核通过";
                    } else if (data == -1) {
                        return "审核不通过";
                    }
                },
                "targets": 8
            },
            {
                "render": function (data, type, row) {
                    if (row.is_audit == 0) {
                        return "&lt;a class='btn btn-primary audit' data-type = 1&gt;通过&lt;/a&gt; &lt;a class='btn btn-danger audit' data-type = 2&gt;不通过&lt;/a&gt;";
                    }
                    return "-";
                },
                "targets": 10
            }
        ],
        "createdRow": function (row, data, index) {
            $('td', row).eq(4).attr('style', 'word-break:break-all');
            $('td', row).eq(2).attr('style', 'word-break:break-all');
            $('td', row).eq(5).attr('style', 'word-break:break-all');
        },
        "language": {
            processing: "数据加载中...",
            info: "显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条记录",
            infoEmpty: "暂无数据",
            lengthMenu: "显示 _MENU_ 条记录",
            paginate: {
                first: "首页",
                previous: "上一页",
                next: "下一页",
                last: "最后一页"
            }
        }
    });

    $dataTable.find('tbody').on('click', '.audit', function () {
        var data = table.row($(this).parents('tr')).data();
        var id = data.id;
        var userid = data.userid;
        var group_id = data.group_id;
        var dynamic_id = data.dynamic_id;
        var dynamic_type = data.dynamic_type;
        var type = $(this).data('type');
        audit(id, type, userid, group_id, dynamic_id, dynamic_type)
    });

    // 审核操作
    function audit(id, type, userid, group_id, dynamic_id, dynamic_type) {
        $.post("{{ route('audit.index') }}/" + id, {
            id: id,
            type: type,
            userid: userid,
            group_id: group_id,
            dynamic_id: dynamic_id,
            dynamic_type: dynamic_type,
            _token: "{{ csrf_token() }}",
            _method: "PUT"
        }, function (data) {
            if (data.result == 0) {
                table.ajax.reload();
                toastr.success("操作成功！");
            }
        });
    }

    $("#is_audit").select2({
        placeholder: "请选择状态",
        minimumResultsForSearch: Infinity
    });

    // 搜索
    $("#searchBtn").click(function(){
        table.draw();
    });
&lt;/script&gt;</pre>

<p><strong>本文主要记录给自己看，不做具体的说明了。</strong></p>

<h4 id="参考链接">参考链接</h4>

<p><a href="https://datatables.net/" target="_blank" rel="noopener nofollow">dataTables 官方文档</a></p>

<p>另外发现一个 Laravel package，专门给 dataTables 提供数据的 API，虽然没用过，但看上去不错。</p>

<p><a href="https://github.com/yajra/laravel-datatables" target="_blank" rel="noopener nofollow"><a href="https://github.com/yajra/laravel-datatables">https://github.com/yajra/laravel-datatables</a></a></p>

<p><audio style="display: none;" controls="controls"></audio></p>

<p><audio style="display: none;" controls="controls"></audio></p>

<p><audio style="display: none;" controls="controls"></audio></p>
  </div>
  
</div>




<script src="http://tanteng.me/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

